---

- name: delete existing
  file: path=/etc/apt/sources.list.d/apt_postgresql_org_pub_repos_apt.list state=absent

- name: 'mode specified as yaml literal 0600'
  apt_repository:
    repo: 'deb http://apt.postgresql.org/pub/repos/apt/ trusty-pgdg main'
    state: present
    mode: 0600
  register: mode_given_results

- name: gather mode_given_as_literal_yaml stat
  stat: path=/etc/apt/sources.list.d/apt_postgresql_org_pub_repos_apt.list
  register: mode_given_yaml_literal_0600

- name: show mode_given_yaml_literal_0600
  debug: var=mode_given_yaml_literal_0600

- name: delete existing
  file: path=/etc/apt/sources.list.d/apt_postgresql_org_pub_repos_apt.list state=absent

- name: assert mode_given_yaml_literal_0600 is correct
  assert: { that: "mode_given_yaml_literal_0600.stat.mode == '0600'" }

- name: 'no mode specified'
  apt_repository:
     repo: 'deb http://apt.postgresql.org/pub/repos/apt/ trusty-pgdg main'
     state: present
  register: no_mode_results

- name: gather no mode stat
  stat: path=/etc/apt/sources.list.d/apt_postgresql_org_pub_repos_apt.list
  register: no_mode_stat

- name: show no mode stat
  debug: var=no_mode_stat

- name: delete
  file: path=/etc/apt/sources.list.d/apt_postgresql_org_pub_repos_apt.list state=absent

- name: assert no_mode_stat is correct
  assert: { that: "no_mode_stat.stat.mode == '0644'" }

- name: delete again
  file: path=/etc/apt/sources.list.d/apt_postgresql_org_pub_repos_apt.list state=absent

- name: 'mode specified as yaml literal 600'
  apt_repository:
    repo: 'deb http://apt.postgresql.org/pub/repos/apt/ trusty-pgdg main'
    state: present
    mode: 600
  register: mode_given_short_results

- name: gather mode_given_yaml_literal_600 stat
  stat: path=/etc/apt/sources.list.d/apt_postgresql_org_pub_repos_apt.list
  register: mode_given_yaml_literal_600

- name: show mode_given_yaml_literal_600
  debug: var=mode_given_yaml_literal_600

- name: delete again
  file: path=/etc/apt/sources.list.d/apt_postgresql_org_pub_repos_apt.list state=absent

- name: 'mode specified as string 0600'
  apt_repository:
     repo: 'deb http://apt.postgresql.org/pub/repos/apt/ trusty-pgdg main'
     state: present
     mode: "0600"
  register: mode_given_string_results

- name: gather mode_given_string stat
  stat: path=/etc/apt/sources.list.d/apt_postgresql_org_pub_repos_apt.list
  register: mode_given_string_stat

- name: show mode_given_string_stat
  debug: var=mode_given_string_stat

- name: delete again
  file: path=/etc/apt/sources.list.d/apt_postgresql_org_pub_repos_apt.list state=absent

- name: 'mode specified as string 600'
  apt_repository:
     repo: 'deb http://apt.postgresql.org/pub/repos/apt/ trusty-pgdg main'
     state: present
     mode: "600"
  register: mode_given_string_600_results

- name: gather mode_given_600_string stat
  stat: path=/etc/apt/sources.list.d/apt_postgresql_org_pub_repos_apt.list
  register: mode_given_string_600_stat

- name: show mode_given_string_stat
  debug: var=mode_given_string_600_stat

- name: delete again
  file: path=/etc/apt/sources.list.d/apt_postgresql_org_pub_repos_apt.list state=absent

- name: assert mode is correct
  assert: { that: "mode_given_string_600_stat.stat.mode == '0600'" }

- name: delete again
  file: path=/etc/apt/sources.list.d/apt_postgresql_org_pub_repos_apt.list state=absent

# Will fail
#- name: assert mode_given_yaml_literal_600 is correct
#  assert: { that: "mode_given_yaml_literal_600.stat.mode == '0600'" }
#
# TEARDOWN
#
- include: 'cleanup.yml'
